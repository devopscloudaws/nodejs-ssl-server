version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging into ECR for all target regions...
      - REGIONS="us-east-1 ap-southeast-1"
      - |
        for REGION in $REGIONS; do
          echo "Logging into ECR in $REGION..."
          aws ecr get-login-password --region $REGION | \
            docker login --username AWS --password-stdin 722136401996.dkr.ecr.$REGION.amazonaws.com
          if [ $? -ne 0 ]; then
            echo "‚ùå Docker login failed for $REGION"
            exit 1
          fi
        done

  build:
    commands:
      - echo Building Docker image...
      - docker build -t example-nodejs .

      - echo Tagging and pushing Docker images to ECR in all regions...
      - |
        for REGION in $REGIONS; do
          IMAGE_URI="722136401996.dkr.ecr.$REGION.amazonaws.com/example-nodejs:latest"
          docker tag example-nodejs:latest $IMAGE_URI
          docker push $IMAGE_URI
        done

      - echo Deploying CloudFormation stacks in all regions...
      - |
        for REGION in $REGIONS; do
          echo "Deploying Network Stack in $REGION..."
          aws cloudformation deploy \
            --region $REGION \
            --stack-name vpc-stack-$REGION \
            --template-file infra/vpc_template.yaml \
            --capabilities CAPABILITY_NAMED_IAM

          echo "Deploying ECS Stack in $REGION..."
          aws cloudformation deploy \
            --region $REGION \
            --stack-name ecs-stack-$REGION \
            --template-file infra/ecs_stack.yaml \
            --parameter-overrides \
              ImageUri=722136401996.dkr.ecr.$REGION.amazonaws.com/example-nodejs:latest \
            --capabilities CAPABILITY_NAMED_IAM

          echo "Deploying ALB Stack in $REGION..."
          aws cloudformation deploy \
            --region $REGION \
            --stack-name alb-stack-$REGION \
            --template-file infra/alb_stack.yaml \
            --capabilities CAPABILITY_NAMED_IAM

          echo "Deploying CloudFront Stack globally..."
          if [ "$REGION" == "us-east-1" ]; then
            aws cloudformation deploy \
              --region $REGION \
              --stack-name waf-cloudfront-stack \
              --template-file infra/waf_cloudfront_stack.yaml \
              --capabilities CAPABILITY_NAMED_IAM
          fi

        done

artifacts:
  files:
    - '**/*'
